id: serverboards.core.actions
name: Core actions
author: David Moreno <dmoreno@serverboards.io>
version: 0.0.1
description: >
  Various core actions.
url: https://serverboards.io

components:
  - name: Ping server
    id: ping
    type: action
    command: serverboards.core.actions/cmd
    call:
      method: ping
      params:
        - name: ip
          label: Remote IP address or DNS name
          type: text
      returns: ms
    traits: ip url # this means any of `ip` or `url`

  - name: Webhook call
    id: webhook.call
    type: action
    command: serverboards.core.actions/cmd
    icon: world
    call:
      method: http_get
      params:
        - name: url
          label: Remote URL
          placeholder: eg. http://example.com, https://example.com/path
          type: text
      returns:
        code: int
        ms: ms
        text: text
    traits: url

  - name: Service tag change
    id: set-tags
    type: action
    command: serverboards.core.actions/cmd
    icon: tag
    call:
      method: set_tags
      params:
        - name: service
          type: text
          label: Service
        - name: tags
          label: Tags to set.
          type: text
          description: Space separated list of tags to add. It can start with a dash to remove the label (-label).
          placeholder: eg. UP -DOWN
          card: true

  - name: Send notification
    id: send-notification
    type: action
    command: cmd
    traits: url
    icon: mail
    call:
      method: send_notification
      extra: true
      params:
        - name: email
          type: text
          label: User email or @group
          card: true
        - name: subject
          type: text
          label: Subject
          card: true
        - name: body
          type: textarea
          lable: Body
        - name: service

  - name: Issue Open
    type: action
    id: open-issue
    command: cmd
    icon: issue
    call:
      method: open_issue
      extra: true
      params:
        - name: title
          type: text
          label: Issue title
          card: true
        - name: description
          type: textarea
          label: Issue description
        - name: aliases
          type: text
          label: Issue aliases
          description: |
            Issue may be referenced by this alias. Useful to allow closing issue
            using the rule.id, or any other identifier for the problem.

            Aliases are separated by spaces.
          placeholder: "eg. rule/\{rule.uuid\}"

  - name: Issue Close
    type: action
    id: close-issue
    command: cmd
    icon: issue
    call:
      method: close_issue
      extra: true
      params:
        - name: issue
          type: text
          label: Issue id or alias
          placeholder: "eg. rule/\{rule.uuid\}"
        - name: comment
          type: textarea
          label: Issue comment

  - name: Notify all users
    type: action template
    id: action.notify_user_template
    actions:
      any:
        action: serverboards.core.actions/send-notification
        params:
          email: @user
          subject: "{{rule.name}}: {{rule.last_state}}"
          body: "{{rule.description}}"

  - name: Mark service up/down
    type: action template
    id: action.tag_updown
    actions:
      up:
        action: serverboards.core.actions/set-tags
        params:
          tags: "+DOWN -UP"
      down:
        action: serverboards.core.actions/set-tags
        params:
          tags: "-DOWN +UP"

  - name: Open issue
    type: action template
    id: action.issue-open-close
    actions:
      down:
        action: serverboards.core.actions/open-issue
        params:
          title: "{rule.name} // {rule.status}"
          description: "{rule.description}"
          aliases: "rule/{rule.uuid}"
      up:
        action: serverboards.core.actions/close-issue
        params:
          issue: "rule/{rule.uuid}"
          comment: "{rule.status}"

  - name: Core actions.
    type: cmd
    id: cmd
    timeout: 20s
    command: serverboards-core.py
    perms: |
      service.info service.update notifications.notify notifications.notify_all
      issues.add issues.update
      settings.view[serverboards.core.settings/base]
